# Fixes Applied - January 16, 2025

## Summary
Fixed three critical issues: map UI overlap, added new user types, and fixed property image upload RLS policy.

---

## 1. ✅ Fixed Map Location Selection UI Overlap

### Problem
When selecting a location on the map, the address details would overlap the container and prevent users from clicking the Save/Cancel buttons.

### Solution
**File:** `src/components/ui/location-map-new.tsx`

**Changes:**
- Changed dialog layout from vertical to horizontal split
- Map now displays on the left side
- Location details panel displays on the right side (fixed width: 320px)
- Action buttons are fixed at the bottom with a border separator
- Added helper text when no location is selected
- Made the dialog use flexbox for proper height management

**Benefits:**
- ✅ No more overlapping content
- ✅ Save/Cancel buttons always accessible
- ✅ Better use of screen space
- ✅ Clearer visual hierarchy
- ✅ Scrollable details panel if content is long

---

## 2. ✅ Added Provider and Customer User Types

### Problem
Only `admin` and `ops` user types existed. Needed to add `provider` (service vendors) and `customer` (property owners/guests).

### Solution

#### A. Updated RBAC Permissions System
**File:** `src/lib/rbac/permissions.ts`

**Added Provider Role:**
- Name: "Service Provider"
- Description: External vendor or service provider with limited access
- **Permissions (8 total):**
  - View/Edit/Complete jobs assigned to them
  - View bookings related to their jobs
  - View/Edit own tasks
  - Create/View issues and upload photos
  - Upload/View/Download media
  - View own commissions

**Added Customer Role:**
- Name: "Customer"
- Description: Property owner or guest with view-only access
- **Permissions (8 total):**
  - View their own properties
  - View bookings and export calendar
  - View/Create issues and upload issue photos
  - View/Download media
  - View financial data and invoices for their properties

#### B. Updated TypeScript Types
**File:** `src/contexts/AuthContext.tsx`

Changed `user_type` from:
```typescript
user_type: 'admin' | 'ops'
```

To:
```typescript
user_type: 'admin' | 'ops' | 'provider' | 'customer'
```

#### C. Updated Database Schema
**File:** `supabase/migrations/20250116_add_provider_customer_user_types.sql`

- Dropped old user_type constraint
- Added new constraint allowing: `admin`, `ops`, `provider`, `customer`

### Testing
After running the migration:
1. Go to User Management
2. Create a new user
3. User type dropdown should now show all 4 options
4. Providers can access jobs/tasks assigned to them
5. Customers can view their properties and bookings

---

## 3. ✅ Fixed Property Images Upload RLS Policy

### Problem
Error when uploading property images:
```
new row violates row-level security policy for table "property_images"
```

### Root Cause
The `property_images` table was not included in the development RLS disable script, causing uploads to be blocked even though other tables had RLS disabled.

### Solution
**File:** `supabase/migrations/20250116_fix_property_images_rls.sql`

**Changes:**
- Disabled RLS for `property_images` table (development only)
- Granted ALL privileges to authenticated users
- Added verification queries to check RLS status

**SQL Applied:**
```sql
ALTER TABLE public.property_images DISABLE ROW LEVEL SECURITY;
GRANT ALL ON public.property_images TO authenticated;
```

### Testing
1. Go to Properties page
2. Click on a property or create a new one
3. Try uploading an image
4. Upload should succeed without RLS errors

### ⚠️ Production Warning
RLS is currently disabled for development. Before deploying to production:
1. Enable RLS: `ALTER TABLE property_images ENABLE ROW LEVEL SECURITY;`
2. Create proper policies (see `001_add_rls_policies.sql` for examples)
3. Test thoroughly with different user roles

---

## Files Modified

### Frontend
1. `src/components/ui/location-map-new.tsx` - Map UI layout fix
2. `src/lib/rbac/permissions.ts` - Added provider/customer roles
3. `src/contexts/AuthContext.tsx` - Updated user_type TypeScript type

### Database Migrations
1. `supabase/migrations/20250116_add_provider_customer_user_types.sql` - Database schema update
2. `supabase/migrations/20250116_fix_property_images_rls.sql` - RLS fix for images

---

## How to Apply These Changes

### Step 1: Run Database Migrations
Open Supabase SQL Editor and run:
```sql
-- Add user types
\i supabase/migrations/20250116_add_provider_customer_user_types.sql

-- Fix property images
\i supabase/migrations/20250116_fix_property_images_rls.sql
```

Or use Supabase CLI:
```bash
npx supabase migration up
```

### Step 2: Refresh Frontend
The frontend changes are already in the code. Just refresh your browser or restart dev server:
```bash
npm run dev
```

### Step 3: Test
1. ✅ Try selecting a location on the map
2. ✅ Create a user with "provider" or "customer" type
3. ✅ Upload an image to a property

---

## User Type Comparison

| Feature | Admin | Ops | Provider | Customer |
|---------|-------|-----|----------|----------|
| **Total Permissions** | 57/57 | 37/57 | 8/57 | 8/57 |
| User Management | ✅ Full | ❌ None | ❌ None | ❌ None |
| Properties | ✅ Full | ✅ CRUD (no delete) | ❌ None | ✅ View Own |
| Jobs | ✅ Full | ✅ Full | ✅ Assigned Only | ❌ None |
| Bookings | ✅ Full | ✅ Full | ✅ View Only | ✅ View Own |
| Todos/Tasks | ✅ Full | ✅ Full | ✅ Own Tasks | ❌ None |
| Issues | ✅ Full | ✅ Full (no delete) | ✅ Create/View | ✅ Create/View |
| Documents | ✅ Full | ⚠️ Mixed | ❌ None | ❌ None |
| Finance | ✅ Full | ✅ View Only | ✅ Own Commission | ✅ View Own |
| Media | ✅ Full | ✅ Full | ✅ Upload/View/Download | ✅ View/Download |
| System Admin | ✅ Full | ❌ None | ❌ None | ❌ None |

---

## Next Steps (Optional)

### For Production:
1. Enable RLS policies for all tables
2. Create proper row-level policies based on user roles
3. Test with real user accounts
4. Set up monitoring for permission violations

### Enhancements:
1. Add provider/customer specific dashboards
2. Create notification system for providers when jobs assigned
3. Add customer portal for property owners
4. Implement provider commission tracking UI

---

**All issues resolved! ✅**
